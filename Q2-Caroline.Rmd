---
title: "Question 2 draft"
output: html_document
---
## relevant libraries
```{r load}
library(tidyverse)
library(rentrez)
library(genbankr)
library(Biostrings)
library(annotate)
library(ape)
```

## load in/format data on accession sequences
covid sequences have different IDs from other viruses, not based on genbank accession number so we have to fix that
```{r cars}
#load the virus table and the COVID sequence acknowledgement table
virus <- read.csv("InputData/TableS11.csv")
covid <- read.delim("InputData/TableS3_GISAID_acknowledgements.dat")

#merge the COVID rows in the virus table with the acknowledgement table
covidMerged <- merge(virus[virus$virus == "SARS2",], covid, by.x = "ID", by.y = "internID")

#filter for only rows with GenBank accession IDs
covidfilter <- covidMerged %>% filter(genbank_accession != "?") 

#replace the alldb ID with the accession ID
covidfilter$ID <- covidfilter$genbank_accession

#select only the columns from the original virus table and rename them
covidfilter <- covidfilter %>% dplyr::select(1:12)
names(covidfilter) <- names(virus)

#replace the original covid rows with the ones we just made
finalvirus <- bind_rows(virus[virus$virus != "SARS2",], covidfilter)
```

## Subset sequences (10 per virus)
```{r}
set.seed(1)
virusSubset <- finalvirus %>% group_by(virus) %>% slice_sample(n = 10)
```

## Get sequences from genbank
```{r}
virusID <- GBAccession(virusSubset$ID)
virusGBK <- read.GenBank(virusID, as.character = TRUE)
```

## Calculate gc content of each sequence and merge with virus types
```{r}
gc <- vector(length = length(virusGBK))
for (i in 1:length(virusGBK)) {
  gc[i] <- length(grep("[gc]", unlist(virusGBK[[i]]))) / length(virusGBK[[i]])
}
gcContent <- data.frame(ID = names(virusGBK), gc = gc)
virusSubset <- merge(virusSubset, gcContent, by = "ID")
```

## Scatterplot of GC content vs. mutation rate and transmission method
```{r}
#load transmission and mutation tables
mutation <- read.delim("InputData/TableS8_edited.dat", header = F)
names(mutation) <- c("virus", "rate", "year")
transmission <- read.csv("InputData/TableS1.csv", header = T)

#calculate mean mutation rate per virus and merge with GC content
mutationMean <- mutation %>% group_by(virus) %>% summarise(meanRate = mean(rate, na.rm = T))
virusSubset <- merge(virusSubset, mutationMean, by = "virus")

#merge transmission data
virusSubset <- merge(virusSubset, transmission, by.x = "virus", by.y = "Abbreviation")

#create scatterplot
ggplot(data = virusSubset, aes(x = gc, y = meanRate)) +
  geom_point(aes(colour = Transmission)) +
  theme_classic() +
  geom_smooth(method = "lm") +
  labs(x = "GC content", y = "Mean mutation rate")
```

